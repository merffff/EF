# GitHub Actions Deploy Workflow
# Ð—Ð°Ð´Ð°Ð½Ð¸Ðµ 4: ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð´ÐµÐ¿Ð»Ð¾Ð¹ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€ Ñ‡ÐµÑ€ÐµÐ· FTP/SSH

name: Deploy to Server

# Ð¢Ñ€Ð¸Ð³Ð³ÐµÑ€: Ð·Ð°Ð¿ÑƒÑÐº Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ð¾ÑÐ»Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾Ð³Ð¾ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ CI Ð¸ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ main Ð²ÐµÑ‚ÐºÐ¸
on:
  workflow_run:
    workflows: ["CI Tests"]
    types:
      - completed
    branches: [ main ]

# ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
env:
  DEPLOY_PATH: /var/www/html

jobs:
  deploy:
    name: Deploy Application
    runs-on: ubuntu-latest

    # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ CI Ð¿Ñ€Ð¾ÑˆÐµÐ» ÑƒÑÐ¿ÐµÑˆÐ½Ð¾
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      # Ð¨Ð°Ð³ 1: Checkout ÐºÐ¾Ð´Ð°
      - name: Checkout code
        uses: actions/checkout@v4

      # Ð¨Ð°Ð³ 2: ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° PHP Ð´Ð»Ñ production build
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, ctype, iconv, intl
          tools: composer:v2

      # Ð¨Ð°Ð³ 3: Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Ð´Ð»Ñ production
      - name: Install production dependencies
        run: composer install --no-dev --optimize-autoloader --no-interaction

      # Ð¨Ð°Ð³ 4: Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ production build
      - name: Create production build
        run: |
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð»Ñ build
          mkdir -p build
          
          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ (Ð¸ÑÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ dev Ñ„Ð°Ð¹Ð»Ñ‹)
          rsync -av --exclude-from='.deployignore' . build/ || cp -r . build/
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ .deployignore ÐµÑÐ»Ð¸ Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
          cat > .deployignore << EOF
          .git/
          .github/
          tests/
          node_modules/
          .env
          .env.example
          phpunit.xml
          pest.php
          composer.lock
          README.md
          .gitignore
          .deployignore
          coverage/
          coverage.xml
          test-results.xml
          EOF

      # Ð¨Ð°Ð³ 5: Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ñ‡ÐµÑ€ÐµÐ· FTP
      - name: Deploy via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        if: ${{ vars.DEPLOY_METHOD == 'ftp' || vars.DEPLOY_METHOD == '' }}
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: ${{ secrets.FTP_PORT || 21 }}
          protocol: ${{ secrets.FTP_PROTOCOL || 'ftp' }}
          local-dir: ./build/
          server-dir: ${{ secrets.FTP_SERVER_DIR || '/' }}
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/tests/**

      # Ð¨Ð°Ð³ 6: Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ñ‡ÐµÑ€ÐµÐ· SSH/SFTP
      - name: Deploy via SSH
        if: ${{ vars.DEPLOY_METHOD == 'ssh' }}
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            # ÐŸÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ð¼ Ð² Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
            cd ${{ secrets.SSH_DEPLOY_PATH || '/var/www/html' }}
            
            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ backup Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¹ Ð²ÐµÑ€ÑÐ¸Ð¸
            if [ -d "current" ]; then
              mv current backup-$(date +%Y%m%d_%H%M%S)
              # Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ Ð±ÑÐºÐ°Ð¿Ñ‹ (Ð¾ÑÑ‚Ð°Ð²Ð»ÑÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ 5 Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ñ…)
              ls -t backup-* | tail -n +6 | xargs rm -rf
            fi
            
            # ÐšÐ»Ð¾Ð½Ð¸Ñ€ÑƒÐµÐ¼ Ð½Ð¾Ð²ÑƒÑŽ Ð²ÐµÑ€ÑÐ¸ÑŽ
            git clone -b main ${{ github.server_url }}/${{ github.repository }}.git current
            cd current
            
            # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
            composer install --no-dev --optimize-autoloader --no-interaction
            
            # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾
            if [ -f "../.env" ]; then
              cp ../.env .env
            fi
            
            # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°
            chmod -R 755 storage
            chmod -R 755 bootstrap/cache
            
            # ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð²ÐµÐ±-ÑÐµÑ€Ð²ÐµÑ€ ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾
            # sudo systemctl reload nginx
            # sudo systemctl reload php8.2-fpm


      # Ð¨Ð°Ð³ 8: Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð¾ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ðµ Ð´ÐµÐ¿Ð»Ð¾Ñ
      - name: Deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Deployment completed successfully!"
            echo "ðŸš€ Application deployed to production server"
          else
            echo "âŒ Deployment failed!"
            echo "ðŸ”§ Please check the logs and fix the issues"
          fi

